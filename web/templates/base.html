<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ffffff">
    <title>Expense Tracker</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link href="/static/style.css" rel="stylesheet">
    <script src="/static/datepicker.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
        window.CATEGORIES = [
            {"name":"Groceries","icon":"üõí","color":"#60a5fa"},
            {"name":"Eating Out","icon":"üç¥","color":"#60a5fa"},
            {"name":"Transport","icon":"üöå","color":"#a78bfa"},
            {"name":"Housing","icon":"üè†","color":"#818cf8"},
            {"name":"Utilities","icon":"üí°","color":"#fbbf24"},
            {"name":"Sport","icon":"üèãÔ∏è‚Äç‚ôÇÔ∏è","color":"#fbbf24"},
            {"name":"Health","icon":"üöë","color":"#fbbf24"},
            {"name":"Entertainment","icon":"üéÆ","color":"#f472b6"},
            {"name":"Travel","icon":"‚úàÔ∏è","color":"#f472b6"},
            {"name":"Gifts","icon":"üéÅ","color":"#fb7185"},
            {"name":"Other","icon":"üì¶","color":"#94a3b8"}
        ];
    </script>
</head>
<body>
    <main id="content">
        {{template "content" .}}
    </main>

    <!-- Expense Modal (Create/Edit) -->
    <div class="create-modal-overlay" id="expense-modal" onclick="if(event.target === this) closeExpenseModal()">
        <div class="create-modal">
            <header class="modal-header">
                <button type="button" class="close-btn" onclick="closeExpenseModal()">√ó</button>
                <h1 id="modal-title">New Expense</h1>
                <button type="button" class="remove-btn" id="modal-remove-btn" style="visibility: hidden;" onclick="deleteExpense()">üóë</button>
<!--                <div></div>-->
            </header>

            <form class="create-form" method="POST" action="/expenses" hx-post="/expenses" hx-target="#content" id="expense-form">
                <section class="amount-display">
                    <div class="amount-row">
                        <div class="amount-hero">
                            <span class="currency">‚Ç¨</span><span id="modal-display-amount">0</span>
                        </div>
                        <button type="button" class="backspace-btn" onclick="modalBackspace()">‚å´</button>
                    </div>
                    <input type="hidden" name="amount" id="modal-amount-input" value="0">
                    <input type="text" name="description" placeholder="Add Note" class="note-input" autocomplete="off" id="modal-description">
                </section>

                <section class="selectors">
                    <div class="selector" onclick="openModalDatePicker()">
                        <input type="hidden" name="date" id="modal-date-input">
                        <div class="selector-btn">
                            <span>üìÖ</span><span id="modal-date-display">Today</span>
                        </div>
                    </div>
                    <label class="selector">
                        <select name="category" id="modal-category-select" onchange="updateModalCategoryDisplay(this)">
                        </select>
                        <div class="selector-btn">
                            <span id="modal-cat-icon"></span><span id="modal-category-display">Category</span>
                        </div>
                    </label>
                </section>

                <section class="keypad">
                    <button type="button" onclick="modalAppendNum('1')">1</button>
                    <button type="button" onclick="modalAppendNum('2')">2</button>
                    <button type="button" onclick="modalAppendNum('3')">3</button>
                    <button type="button" onclick="modalAppendNum('4')">4</button>
                    <button type="button" onclick="modalAppendNum('5')">5</button>
                    <button type="button" onclick="modalAppendNum('6')">6</button>
                    <button type="button" onclick="modalAppendNum('7')">7</button>
                    <button type="button" onclick="modalAppendNum('8')">8</button>
                    <button type="button" onclick="modalAppendNum('9')">9</button>
                    <button type="button" onclick="modalAppendNum('.')">.</button>
                    <button type="button" onclick="modalAppendNum('0')">0</button>
                    <button type="submit" class="submit">‚úì</button>
                </section>
            </form>

            <!-- Date Picker Modal (nested) -->
            <div class="date-modal-overlay" id="modal-date-picker" onclick="if(event.target === this) closeModalDatePicker()">
                <div class="date-modal">
                    <div class="calendar-header">
                        <button type="button" onclick="changeModalMonth(-1)">‚Äπ</button>
                        <h3 id="modal-calendar-month-year">Month Year</h3>
                        <button type="button" onclick="changeModalMonth(1)">‚Ä∫</button>
                    </div>
                    <div class="calendar-grid" id="modal-calendar-grid">
                        <div class="calendar-day-header">Mo</div>
                        <div class="calendar-day-header">Tu</div>
                        <div class="calendar-day-header">We</div>
                        <div class="calendar-day-header">Th</div>
                        <div class="calendar-day-header">Fr</div>
                        <div class="calendar-day-header">Sa</div>
                        <div class="calendar-day-header">Su</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        let modalAmt = '0';
        let modalViewDate = new Date();
        let currentExpenseId = null;

        // Populate category select
        function populateCategories() {
            const select = document.getElementById('modal-category-select');
            if (!select || select.options.length > 0) return;
            window.CATEGORIES.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.name;
                opt.textContent = cat.icon + ' ' + cat.name;
                select.appendChild(opt);
            });
        }

        window.openCreateModal = function() {
            currentExpenseId = null;
            modalAmt = '0';
            document.getElementById('modal-title').textContent = 'New Expense';
            document.getElementById('modal-display-amount').textContent = '0';
            document.getElementById('modal-amount-input').value = '0';
            document.getElementById('modal-description').value = '';
            document.getElementById('modal-remove-btn').style.visibility = 'hidden';
            
            // Set form action for create
            const form = document.getElementById('expense-form');
            form.action = '/expenses';
            form.setAttribute('hx-post', '/expenses');
            htmx.process(form);
            
            // Set date to now
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('modal-date-input').value = now.toISOString().slice(0, 19);
            updateModalDateDisplay();
            
            populateCategories();
            document.getElementById('modal-category-select').selectedIndex = 0;
            updateModalCategoryDisplay(document.getElementById('modal-category-select'));
            
            document.getElementById('expense-modal').classList.add('open');
        };

        window.openEditModal = function(id, amount, description, category, date) {
            currentExpenseId = id;
            modalAmt = amount.toString();
            if (modalAmt.includes('.')) {
                // Clean up trailing zeros but keep at least one decimal place for display
                modalAmt = parseFloat(modalAmt).toString();
            }
            
            document.getElementById('modal-title').textContent = 'Edit Expense';
            document.getElementById('modal-display-amount').textContent = modalAmt;
            document.getElementById('modal-amount-input').value = modalAmt;
            document.getElementById('modal-description').value = description || '';
            document.getElementById('modal-remove-btn').style.visibility = 'unset';
            
            // Set form action for edit
            const form = document.getElementById('expense-form');
            form.action = '/expenses/' + id;
            form.setAttribute('hx-post', '/expenses/' + id);
            htmx.process(form);
            
            // Set date
            document.getElementById('modal-date-input').value = date;
            updateModalDateDisplay();
            
            populateCategories();
            const select = document.getElementById('modal-category-select');
            select.value = category;
            updateModalCategoryDisplay(select);
            
            document.getElementById('expense-modal').classList.add('open');
        };

        window.closeExpenseModal = function() {
            document.getElementById('expense-modal').classList.remove('open');
        };

        // Keep old function name for compatibility
        window.closeCreateModal = closeExpenseModal;

        window.deleteExpense = function() {
            if (!currentExpenseId) return;
            if (!confirm('Delete this expense?')) return;
            
            htmx.ajax('DELETE', '/expenses/' + currentExpenseId, {
                target: '#content',
                swap: 'innerHTML'
            }).then(function() {
                closeExpenseModal();
            });
        };

        window.modalAppendNum = function(n) {
            if (modalAmt === '0' && n !== '.') modalAmt = n;
            else if (n === '.' && modalAmt.includes('.')) return;
            else if (modalAmt.replace('.','').length >= 9) return;
            else modalAmt += n;
            document.getElementById('modal-display-amount').textContent = modalAmt;
            document.getElementById('modal-amount-input').value = modalAmt;
        };

        window.modalBackspace = function() {
            modalAmt = modalAmt.length === 1 ? '0' : modalAmt.slice(0, -1);
            document.getElementById('modal-display-amount').textContent = modalAmt;
            document.getElementById('modal-amount-input').value = modalAmt;
        };

        window.updateModalCategoryDisplay = function(sel) {
            if (!sel) return;
            const cat = window.CATEGORIES.find(c => c.name === sel.value);
            document.getElementById('modal-category-display').textContent = sel.value.charAt(0).toUpperCase() + sel.value.slice(1);
            document.getElementById('modal-cat-icon').textContent = cat ? cat.icon : 'üì¶';
        };

        function updateModalDateDisplay() {
            const input = document.getElementById('modal-date-input');
            if (!input) return;
            const d = new Date(input.value || new Date());
            const isToday = d.toDateString() === new Date().toDateString();
            document.getElementById('modal-date-display').textContent = isToday ? 'Today' : d.toLocaleDateString(undefined, {day:'numeric',month:'short'});
        }

        window.openModalDatePicker = function() {
            const input = document.getElementById('modal-date-input');
            if (input.value) modalViewDate = new Date(input.value);
            else modalViewDate = new Date();
            renderModalCalendar();
            document.getElementById('modal-date-picker').classList.add('open');
        };

        window.closeModalDatePicker = function() {
            document.getElementById('modal-date-picker').classList.remove('open');
        };

        window.changeModalMonth = function(delta) {
            modalViewDate.setMonth(modalViewDate.getMonth() + delta);
            renderModalCalendar();
        };

        window.selectModalDate = function(year, month, day) {
            const input = document.getElementById('modal-date-input');
            let timePart = '12:00:00';
            if (input.value && input.value.includes('T')) {
                timePart = input.value.split('T')[1];
                if (timePart.length === 5) timePart += ':00';
            } else {
                const now = new Date();
                timePart = now.toTimeString().slice(0, 8);
            }
            const d = new Date(year, month, day);
            const dateStr = d.getFullYear() + '-' + 
                           String(d.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(d.getDate()).padStart(2, '0');
            input.value = dateStr + 'T' + timePart;
            updateModalDateDisplay();
            closeModalDatePicker();
        };

        function renderModalCalendar() {
            const year = modalViewDate.getFullYear();
            const month = modalViewDate.getMonth();
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            document.getElementById('modal-calendar-month-year').textContent = monthNames[month] + ' ' + year;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = (firstDay.getDay() + 6) % 7;

            const grid = document.getElementById('modal-calendar-grid');
            const headers = grid.querySelectorAll('.calendar-day-header');
            grid.innerHTML = '';
            headers.forEach(h => grid.appendChild(h));

            for (let i = 0; i < startDay; i++) {
                const div = document.createElement('div');
                div.className = 'calendar-day empty';
                grid.appendChild(div);
            }

            const today = new Date();
            const inputEl = document.getElementById('modal-date-input');
            const inputDate = new Date(inputEl && inputEl.value ? inputEl.value : new Date());

            for (let d = 1; d <= daysInMonth; d++) {
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.textContent = d;
                if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                    div.classList.add('today');
                }
                if (year === inputDate.getFullYear() && month === inputDate.getMonth() && d === inputDate.getDate()) {
                    div.classList.add('selected');
                }
                div.onclick = () => selectModalDate(year, month, d);
                grid.appendChild(div);
            }
        }

        // Close modal when expense form triggers HX-Location (redirect after success)
        document.body.addEventListener('htmx:beforeOnLoad', function(evt) {
            if (evt.detail.elt && evt.detail.elt.id === 'expense-form') {
                closeExpenseModal();
            }
        });
    })();
    </script>
</body>
</html>
